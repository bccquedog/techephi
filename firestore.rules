rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow users to read and write their own profile data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && (
        // Admins can read all user profiles
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    // Jobs collection - users can read/write jobs they're associated with
    match /jobs/{jobId} {
      allow read: if request.auth != null && (
        // Users can read jobs where they are the client, contractor, or admin
        resource.data.clientEmail == request.auth.token.email ||
        resource.data.contractorEmail == request.auth.token.email ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      allow write: if request.auth != null && (
        // Admins can write all jobs
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        // Contractors can update jobs assigned to them
        (resource.data.contractorEmail == request.auth.token.email && 
         request.resource.data.contractorEmail == request.auth.token.email) ||
        // Clients can update their own jobs (limited fields)
        (resource.data.clientEmail == request.auth.token.email && 
         request.resource.data.clientEmail == request.auth.token.email)
      );
    }
    
    // Clients collection - admins can manage all clients
    match /clients/{clientId} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Invoices collection
    match /invoices/{invoiceId} {
      allow read: if request.auth != null && (
        // Users can read invoices where they are the client or admin
        resource.data.clientEmail == request.auth.token.email ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Messages collection
    match /messages/{messageId} {
      allow read, write: if request.auth != null && (
        // Users can read/write messages where they are a participant
        resource.data.participants[request.auth.uid] == true ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    // Conversations collection (for expert chat)
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null && (
        // Users can read/write conversations they're part of
        request.auth.token.email in resource.data.participants ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null && (
        // Users can read/write their own notifications
        resource.data.userEmail == request.auth.token.email ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    // Files collection
    match /files/{fileId} {
      allow read: if request.auth != null && (
        // Users can read files associated with their jobs or admin
        resource.data.jobId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.jobs ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Time tracking collection
    match /timeTracking/{entryId} {
      allow read, write: if request.auth != null && (
        // Users can read/write their own time entries
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    // Approvals collection
    match /approvals/{approvalId} {
      allow read, write: if request.auth != null && (
        // Users can read/write approvals for jobs they're associated with
        resource.data.jobId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.jobs ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    // Test collection - allow writes for testing purposes
    match /test/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // Development mode - allow all access for testing (REMOVE IN PRODUCTION)
    match /{document=**} {
      allow read, write: if true;
    }
  }
}


